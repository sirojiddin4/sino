{# Template for multiple choice tickbox questions #}
{# Used for: multiple_choice_multi #}

{% load template_filters %}

<div class="multiple-choice-tickbox-container">
    {% for option in question.options.all %}
    <div class="form-check">
        <input class="form-check-input answer-input" 
               type="checkbox" 
               name="question_{{ question.id }}" 
               id="option_{{ option.id }}" 
               value="{{ option.id }}" 
               {% if user_answer.answer|split_answer|contains:option.id|stringformat:"s" %}checked{% endif %}
               data-question-id="{{ question.id }}">
        <label class="form-check-label" for="option_{{ option.id }}">
            {{ option.text }}
        </label>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all checkboxes for this question
    const checkboxes = document.querySelectorAll('input[name="question_{{ question.id }}"]');
    
    // Add event listeners to each checkbox
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Get all checked values
            const checkedValues = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value)
                .join(',');
            
            // Save the answer
            saveMultipleChoiceAnswer('{{ question.id }}', checkedValues);
        });
    });
    
    // Function to save the multiple choice answer
    function saveMultipleChoiceAnswer(questionId, answer) {
        // Create a hidden input and trigger change event to use the existing save mechanism
        const hiddenInput = document.createElement('input');
        hiddenInput.classList.add('answer-input');
        hiddenInput.value = answer;
        hiddenInput.dataset.questionId = questionId;
        
        // Append to DOM (not visible)
        document.body.appendChild(hiddenInput);
        
        // Trigger change event to save
        const event = new Event('change');
        hiddenInput.dispatchEvent(event);
        
        // Remove the hidden input
        document.body.removeChild(hiddenInput);
    }
});
</script>